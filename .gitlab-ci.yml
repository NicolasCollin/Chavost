stages:
  - lint
  - typecheck
  - audit
  - test

# Base template for Python installation (no uv)
.ci-template:
  image: python:3.13-slim
  before_script:
    - python -m pip install --upgrade pip
    - |
      if [ -f requirements.txt ]; then
        pip install -r requirements.txt
      elif [ -f pyproject.toml ]; then
        # Install project and dev tools directly when no requirements.txt
        pip install . pre-commit mypy pytest behave pip-audit
      fi

# Lint step (pre-commit)
lint:
  stage: lint
  extends: .ci-template
  script:
    - pre-commit run --all-files --show-diff-on-failure
  allow_failure: true

# Type checking with mypy
typecheck:
  stage: typecheck
  extends: .ci-template
  script:
    - mypy src
  allow_failure: true

# Dependency security audit
audit:
  stage: audit
  extends: .ci-template
  script:
    - pip-audit || true
  allow_failure: true

# Unit tests and behave tests
test:
  stage: test
  extends: .ci-template
  script:
    - |
      if [ -d tests ]; then
        pytest --doctest-modules --maxfail=3 --disable-warnings -q || true
      else
        echo "No pytest tests directory; skipping."
      fi
    - |
      if [ -d tests/behave/features ]; then
        behave tests/behave/features || true
      else
        echo "No behave features; skipping."
      fi
